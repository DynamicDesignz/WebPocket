import socket
from lib.BaseExploit import BaseExploit
from lib.ExploitOption import ExploitOption


class Exploit(BaseExploit):
    def __init__(self):
        super(Exploit, self).__init__()
        self.update_info({
            "name": "redis unauthorized",
            "description": "redis unauthorized",
            "author": ["unknown"],
            "references": [
                "https://www.freebuf.com/column/158065.html",
            ],
            "disclosure_date": "2019-02-28",
            "service_name": "redis",
            "service_version": "*",
        })
        self.register_options([
            ExploitOption(
                name="host",
                required=True,
                description="The IP of the machine to be tested",
                value=None
            ),
            ExploitOption(
                name="timeout",
                required=False,
                description="The timeout for connecting to redis",
                value=10,
            ),
            ExploitOption(
                name="port",
                required=False,
                description="redis port",
                value=6379
            )
        ])

    def check(self):
        host = self.options.get_option("host")
        port = int(self.options.get_option("port"))
        timeout = self.options.get_option("timeout")
        try:
            socket.setdefaulttimeout(timeout)
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.connect((host, port))
            s.send(bytes("INFO\r\n", encoding="utf-8"))
            result = s.recv(1024)
            if bytes("redis_version", encoding="utf-8") in result:
                self.results.success(
                    data={
                        "host": host,
                        "port": port,
                    },
                    message="Host {} exists redis unauthorized vulnerability".format(host)
                )
            else:
                self.results.failure(
                    error_message="Host {} does not exists redis unauthorized vulnerability".format(host)
                )
        except Exception as e:
            self.results.failure(error_message=e)
        return self.results

    def exploit(self):
        return self.check()
